# Sokonet Restaurant Management API

A comprehensive restaurant management system API with QR code-based ordering, payment processing, and multi-tenant business management.

## üöÄ Features

- **Multi-tenant Business Management**: Support for multiple restaurant businesses
- **QR Code-based Ordering**: Generate and manage QR codes for customer identification
- **Role-based Access Control**: Super Admin, Business Owners, Dispatchers, QR Scanners, and Customers
- **Digital Wallet Integration**: Customer wallet system with Pesapal payment gateway
- **Order Management**: Complete order lifecycle from creation to delivery
- **File Storage**: DigitalOcean Spaces integration for image uploads
- **Email Notifications**: Automated email notifications for various events
- **Rate Limiting**: API protection with configurable rate limits

## üõ† Technology Stack

- **Runtime**: Node.js (Latest LTS)
- **Framework**: Express.js 4.18.2
- **Database**: MySQL with Sequelize ORM and Prisma
- **Authentication**: JWT tokens with refresh token mechanism
- **File Storage**: DigitalOcean Spaces (S3-compatible)
- **Payment**: Pesapal integration for card/M-Pesa payments
- **Email**: Hostinger SMTP with Nodemailer\n\n## üìã Prerequisites\n\n- Node.js (v18 or higher)\n- MySQL database\n- DigitalOcean Spaces account\n- Pesapal merchant account\n- SMTP email service\n\n## üîß Installation\n\n1. **Clone the repository**\n   ```bash\n   git clone <repository-url>\n   cd sokonet-api\n   ```\n\n2. **Install dependencies**\n   ```bash\n   npm install\n   ```\n\n3. **Environment Configuration**\n   \n   Create a `.env` file in the root directory:\n   ```env\n   # Server Configuration\n   PORT=3000\n   NODE_ENV=development\n   \n   # Database Configuration\n   DB_HOST=your_mysql_host\n   DB_PORT=3306\n   DB_NAME=your_database_name\n   DB_USER=your_database_user\n   DB_PASSWORD=your_database_password\n   DB_DIALECT=mysql\n   \n   # JWT Configuration\n   JWT_SECRET=your_jwt_secret_key\n   JWT_EXPIRE=15m\n   JWT_REFRESH_SECRET=your_refresh_secret_key\n   JWT_REFRESH_EXPIRE=7d\n   \n   # Email Configuration\n   EMAIL_HOST=smtp.titan.email\n   EMAIL_PORT=587\n   EMAIL_SECURE=false\n   EMAIL_USER=your_email@domain.com\n   EMAIL_PASS=your_email_password\n   EMAIL_FROM=your_email@domain.com\n   \n   # DigitalOcean Spaces\n   DO_SPACES_KEY=your_spaces_key\n   DO_SPACES_SECRET=your_spaces_secret\n   DO_SPACES_ENDPOINT=sfo3.digitaloceanspaces.com\n   DO_SPACES_BUCKET=your_bucket_name\n   DO_SPACES_REGION=sfo3\n   DO_SPACES_BASE_URL=https://your_bucket.sfo3.digitaloceanspaces.com\n   \n   # Pesapal Configuration\n   PESAPAL_CONSUMER_KEY=your_pesapal_key\n   PESAPAL_CONSUMER_SECRET=your_pesapal_secret\n   PESAPAL_ENVIRONMENT=sandbox\n   PESAPAL_CALLBACK_URL=http://localhost:3000/api/payments/pesapal/callback\n   \n   # Application Configuration\n   APP_NAME=Sokonet Restaurant Management\n   APP_URL=http://localhost:3000\n   FRONTEND_URL=http://localhost:5173\n   ```\n\n4. **Database Setup**\n   \n   The application will automatically create tables and relationships when started in development mode.\n\n5. **Start the server**\n   ```bash\n   # Development\n   npm run dev\n   \n   # Production\n   npm start\n   ```\n\n## üîê User Roles & Access\n\n### Super Admin\n- **Access**: Full system control\n- **Capabilities**: \n  - Manage all businesses\n  - View system analytics\n  - Create admin accounts\n  - Process refunds\n\n### Business Owner\n- **Access**: Own business management\n- **Capabilities**:\n  - Manage business profile\n  - Create staff accounts (Dispatchers & Scanners)\n  - Manage products and categories\n  - Generate QR codes\n  - View business reports\n\n### Dispatcher (Sales Staff)\n- **Access**: Order processing\n- **Capabilities**:\n  - Create orders\n  - Scan customer QR codes\n  - Process payments\n  - Update order status\n\n### QR Scanner (Entrance Staff)\n- **Access**: QR code assignment\n- **Capabilities**:\n  - Assign QR codes to customers\n  - Verify QR code authenticity\n  - View assignment history\n\n### Customer/User\n- **Access**: Personal account & orders\n- **Capabilities**:\n  - Manage profile\n  - Top-up wallet\n  - View order history\n  - Track QR code\n\n## üì° API Endpoints\n\n### Health Check\n```http\nGET /health\n```\n\n### Authentication\n\n#### User Authentication\n```http\nPOST /api/auth/user/register\nPOST /api/auth/user/login\nPOST /api/auth/user/verify-email\nPOST /api/auth/user/forgot-password\nPOST /api/auth/user/reset-password\n```\n\n#### Business Authentication\n```http\nPOST /api/auth/business/register\nPOST /api/auth/business/login\n```\n\n#### Admin Authentication\n```http\nPOST /api/auth/admin/login\n```\n\n### Business Management\n```http\nGET    /api/business/profile\nPUT    /api/business/profile\nPOST   /api/business/upload-logo\n\n# Staff Management\nGET    /api/business/staff\nPOST   /api/business/staff/dispatcher\nPOST   /api/business/staff/scanner\n\n# Product Management\nGET    /api/business/products\nPOST   /api/business/products\nPUT    /api/business/products/:id\nDELETE /api/business/products/:id\n\n# QR Code Management\nGET    /api/business/qrcodes\nPOST   /api/business/qrcodes/generate\nPOST   /api/business/qrcodes/generate-pdf\n```\n\n### User/Customer Routes\n```http\nGET  /api/user/profile\nPUT  /api/user/profile\nGET  /api/user/wallet\nPOST /api/user/wallet/topup\nGET  /api/user/orders\n```\n\n### Dispatcher Routes\n```http\nGET  /api/dispatcher/orders\nPOST /api/dispatcher/orders\nPOST /api/dispatcher/scan-customer\nPOST /api/dispatcher/process-payment\n```\n\n### Scanner Routes\n```http\nGET  /api/scanner/qrcodes/unassigned\nPOST /api/scanner/assign-qrcode\nPOST /api/scanner/scan-assignment\n```\n\n## üéØ QR Code System\n\n### QR Code Generation\n1. Business generates QR codes in bulk (10, 50, 100, 500, 1000)\n2. QR codes are stored as images in DigitalOcean Spaces\n3. Print-ready PDFs can be generated for physical tags\n\n### QR Code Assignment Process\n1. QR Scanner staff scans printed QR code\n2. Selects customer from database\n3. Assigns QR code to customer account\n4. Customer receives email notification\n\n### Order Processing with QR\n1. Dispatcher creates order\n2. Scans customer QR code for identification\n3. Processes payment from customer wallet\n4. Updates order status\n\n## üí≥ Payment System\n\n### Wallet Top-up Flow\n1. Customer initiates top-up via API\n2. System creates pending transaction\n3. Pesapal payment URL generated\n4. Customer completes payment\n5. Webhook updates wallet balance\n\n### Order Payment Flow\n1. Order created by dispatcher\n2. Customer QR scanned for identification\n3. Wallet balance checked\n4. Payment processed if sufficient funds\n5. Transaction recorded\n\n## üìß Email Notifications\n\n- Welcome emails with verification OTP\n- Password reset notifications\n- Order confirmations and status updates\n- QR code assignment notifications\n- Wallet transaction confirmations\n- Staff account creation emails\n\n## üîí Security Features\n\n- **JWT Authentication**: Access and refresh tokens\n- **Rate Limiting**: Configurable API rate limits\n- **Input Validation**: Comprehensive request validation\n- **Password Security**: Bcrypt hashing with salt rounds\n- **Role-based Access**: Granular permission system\n- **CORS Protection**: Cross-origin request security\n\n## üìä Database Schema\n\n### Core Models\n- **Users**: Customer accounts with wallet integration\n- **Businesses**: Multi-tenant business entities\n- **Products**: Business product catalog\n- **Orders**: Order management with items\n- **QRCodes**: QR code assignment system\n- **Transactions**: Payment transaction history\n- **Staff**: Dispatcher and Scanner accounts\n\n### Key Relationships\n- Business ‚Üí Products, QRCodes, Orders, Staff\n- User ‚Üí Wallet, Orders, QRCode, Transactions\n- Order ‚Üí OrderItems, Transactions\n\n## üöÄ Deployment\n\n### Environment Variables\nEnsure all environment variables are properly configured for production:\n\n```env\nNODE_ENV=production\nDB_HOST=your_production_db_host\n# ... other production configs\n```\n\n### Database Migration\n```bash\nnpm run migrate\nnpm run seed\n```\n\n### Process Management\nRecommended to use PM2 for production:\n```bash\nnpm install -g pm2\npm2 start src/server.js --name sokonet-api\n```\n\n## üß™ Testing\n\n```bash\n# Run tests\nnpm test\n\n# Run tests with coverage\nnpm run test:coverage\n```\n\n## üìà Monitoring\n\n- API response time monitoring\n- Error rate tracking\n- Database performance metrics\n- User activity analytics\n\n## ü§ù Contributing\n\n1. Fork the repository\n2. Create feature branch (`git checkout -b feature/AmazingFeature`)\n3. Commit changes (`git commit -m 'Add AmazingFeature'`)\n4. Push to branch (`git push origin feature/AmazingFeature`)\n5. Open Pull Request\n\n## üìÑ License\n\nThis project is licensed under the ISC License.\n\n## üìû Support\n\nFor support and questions, please contact the development team.\n\n---\n\n**Built with ‚ù§Ô∏è for the restaurant industry**